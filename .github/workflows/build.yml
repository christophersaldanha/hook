name: Build iOS Dylib

on:
  push:
    paths:
      - '**.mm'
      - '**/CMakeLists.txt'
      - '.github/workflows/build.yml'

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install CMake
        run: brew install cmake

      - name: Create CMakeLists.txt
        run: |
          cat <<EOF > CMakeLists.txt
          cmake_minimum_required(VERSION 3.13)
          project(Hook)
          set(CMAKE_OSX_SYSROOT iphoneos)
          set(CMAKE_OSX_ARCHITECTURES arm64)
          set(CMAKE_CXX_FLAGS "\${CMAKE_CXX_FLAGS} -fobjc-arc -std=c++17")
          add_library(hook SHARED hook.mm)
          EOF

      - name: Build dylib
        run: |
          mkdir -p build
          cd build
          cmake ..
          make

      - name: Upload dylib
        uses: actions/upload-artifact@v3
        with:
          name: codm_hook_dylib
          path: build/libhook.dylib
